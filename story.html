<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>Digimod-Vektars</title>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="html5/data/js/supabase-config.js"></script>

    <style>
      /* Reset & Base */
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #ffffff;
      }

      #app,
      #preso {
        height: 100%;
        width: 100%;
      }

      /* Buttons Base Style */
      .app-button {
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        outline: none;
        z-index: 99999;
      }

      .app-button svg {
        fill: currentColor;
        pointer-events: none;
      }

      /* Fullscreen Button */
      .fullscreen-btn {
        background: rgba(44, 62, 80, 0.9);
        color: white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      .fullscreen-btn:hover {
        background: rgba(52, 73, 94, 0.95);
        transform: scale(1.05);
      }

      /* Logout Button */
      .logout-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .logout-btn:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      /* Desktop Layout */
      @media (min-width: 769px) {
        .fullscreen-btn {
          position: absolute;
          top: 10px;
          right: 10px;
          width: 36px;
          height: 36px;
          padding: 8px;
        }

        .logout-btn {
          position: absolute;
          top: 56px;
          right: 10px;
          width: 36px;
          height: 36px;
          padding: 8px;
        }

        .app-button svg {
          width: 16px;
          height: 16px;
        }
      }

      /* Mobile Layout */
      @media (max-width: 768px) {
        .fullscreen-btn,
        .logout-btn {
          position: fixed !important;
          width: 44px;
          height: 44px;
          padding: 10px;
          right: 15px;
        }

        .fullscreen-btn {
          top: 15px;
        }

        .logout-btn {
          top: 70px;
        }

        .app-button svg {
          width: 20px;
          height: 20px;
        }
      }

      /* Fullscreen Mode */
      .storyline-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9998 !important;
        background: #000;
      }

      /* Loading Indicator */
      .slide-loader {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10000;
      }

      .mobile-loader-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin: 0 3px;
        animation: bounce 1.4s ease-in-out infinite both;
      }

      .mobile-loader-dot.dot2 {
        animation-delay: -0.32s;
      }
      .mobile-loader-dot.dot3 {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Mobile Title Overlay */
      .mobile-load-title-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-load-title {
        color: white;
        font-size: 24px;
        font-weight: bold;
      }

      /* Utility Classes */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body class="cs-HTML theme-classic">
    <!-- Focus Management -->
    <div id="focus-sink" tabindex="-1"></div>

    <!-- Main Content -->
    <div id="preso"></div>

    <!-- Loading Indicator -->
    <div class="slide-loader"></div>

    <!-- Mobile Title Overlay -->
    <div class="mobile-load-title-overlay hidden">
      <div class="mobile-load-title">Digimod-Vektars</div>
    </div>

    <!-- Mobile Chrome Warning -->
    <div class="mobile-chrome-warning"></div>

    <script>
      // ===========================================
      // APP CONFIGURATION
      // ===========================================
      window.globals = {
        DATA_PATH_BASE: "",
        HAS_FRAME: true,
        HAS_SLIDE: true,
        scale: "noscale",
        bgColor: "#FFFFFF",
        themeName: "classic",
        preloaderColor: "#FFFFFF",
        aid: "",
        cid: "67d594d7-92a8-494c-89df-a95b3e0aeeef",
        playerVersion: "3.17.27621.0",

        parseParams: function (qs) {
          if (this.parsedParams) return this.parsedParams;

          qs = (qs || window.location.search.substr(1)).split("+").join(" ");
          const params = {};
          const re = /[?&]?([^=]+)=([^&]*)/g;
          let tokens;

          while ((tokens = re.exec(qs))) {
            params[decodeURIComponent(tokens[1]).trim()] = decodeURIComponent(
              tokens[2]
            ).trim();
          }

          this.parsedParams = params;
          return params;
        },
      };

      // ===========================================
      // DEVICE DETECTION
      // ===========================================
      class DeviceDetector {
        static detect() {
          const ua = navigator.userAgent;
          const isMobile =
            /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
          const isTablet =
            /iPad|Android(?!.*Mobile)/i.test(ua) ||
            (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
          const isPhone = isMobile && !isTablet;

          return {
            mobile: isMobile,
            tablet: isTablet,
            phone: isPhone,
            desktop: !isMobile,
          };
        }
      }

      // ===========================================
      // AUTHENTICATION SYSTEM
      // ===========================================
      class AuthSystem {
        static skipPages = ["#63itxUiYU5C", "#5rgG71N9RMX", "#/", ""];

        static shouldRequireAuth() {
          const hash = window.location.hash;
          return (
            !this.skipPages.includes(hash) &&
            !window.location.pathname.includes("auth.html")
          );
        }

        static getCurrentUser() {
          const userData = sessionStorage.getItem("currentUser");
          return userData ? JSON.parse(userData) : null;
        }

        static checkAuth() {
          if (!this.shouldRequireAuth()) return true;

          const user = this.getCurrentUser();
          if (!user) {
            window.location.href = "auth.html";
            return false;
          }
          return true;
        }

        static setUserDataInStoryline() {
          try {
            const user = this.getCurrentUser();
            if (!user || typeof GetPlayer !== "function") return;

            const player = GetPlayer();
            if (player) {
              player.SetVar("Namalengkap", user.nama_lengkap || "");
              player.SetVar("Username", user.username || "");
              player.SetVar("Kelas", user.kelas || "");
              player.SetVar("AsalSekolah", user.asal_sekolah || "");
              player.SetVar("Email", user.email || "");
              player.SetVar("UserID", user.id || "");
            }
          } catch (error) {
            console.error("Error setting user data:", error);
          }
        }

        static logout() {
          if (!confirm("Yakin ingin keluar dari sistem?")) return;

          const user = this.getCurrentUser();
          if (user?.id && window.AuthService) {
            window.AuthService.logActivity(
              user.id,
              "logout",
              "User logged out"
            );
          }

          sessionStorage.clear();
          window.location.href = "story.html";
        }

        static init() {
          if (!this.checkAuth()) return;

          // Monitor hash changes
          window.addEventListener("hashchange", () => {
            this.checkAuth();
            this.interceptLoginSlide();
          });

          // Set user data when ready
          if (typeof GetPlayer === "function") {
            this.setUserDataInStoryline();
          } else {
            window.addEventListener("load", () => {
              setTimeout(() => this.setUserDataInStoryline(), 1000);
            });
          }
        }

        static interceptLoginSlide() {
          const hash = window.location.hash;
          if (hash.includes("5orjAoE8cPl")) {
            const user = this.getCurrentUser();
            if (user) {
              window.location.hash = "/next-slide";
            } else {
              window.location.href = "auth.html";
            }
          }
        }
      }

      // ===========================================
      // UI CONTROLS
      // ===========================================
      class UIControls {
        constructor() {
          this.device = DeviceDetector.detect();
          this.fullscreenBtn = null;
          this.logoutBtn = null;
          this.isFullscreen = false;
          this.container = null;
        }

        createButton(type, iconPath, ariaLabel) {
          const button = document.createElement("button");
          button.className = `app-button ${type}-btn`;
          button.setAttribute("aria-label", ariaLabel);
          button.setAttribute("title", ariaLabel);
          button.innerHTML = `
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="${iconPath}"/>
                    </svg>
                    <span class="sr-only">${ariaLabel}</span>
                `;
          return button;
        }

        createFullscreenButton() {
          const button = this.createButton(
            "fullscreen",
            "M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z",
            "Toggle Fullscreen"
          );

          button.addEventListener("click", () => this.toggleFullscreen());
          return button;
        }

        createLogoutButton() {
          const button = this.createButton(
            "logout",
            "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9",
            "Logout"
          );

          button.addEventListener("click", () => AuthSystem.logout());
          return button;
        }

        updateFullscreenIcon() {
          if (!this.fullscreenBtn) return;

          const path = this.fullscreenBtn.querySelector("path");
          const srText = this.fullscreenBtn.querySelector(".sr-only");

          if (this.isFullscreen) {
            path.setAttribute(
              "d",
              "M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"
            );
            this.fullscreenBtn.setAttribute("aria-label", "Exit fullscreen");
            srText.textContent = "Exit fullscreen";
          } else {
            path.setAttribute(
              "d",
              "M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"
            );
            this.fullscreenBtn.setAttribute("aria-label", "Enter fullscreen");
            srText.textContent = "Enter fullscreen";
          }
        }

        toggleFullscreen() {
          if (!this.container) return;

          if (!this.isFullscreen) {
            // Enter fullscreen
            if (this.container.requestFullscreen) {
              this.container.requestFullscreen();
            } else if (this.container.webkitRequestFullscreen) {
              this.container.webkitRequestFullscreen();
            } else if (this.container.mozRequestFullScreen) {
              this.container.mozRequestFullScreen();
            } else if (this.container.msRequestFullscreen) {
              this.container.msRequestFullscreen();
            }
          } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
              document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
              document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
              document.msExitFullscreen();
            }
          }
        }

        handleFullscreenChange() {
          this.isFullscreen = !!(
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement
          );

          this.updateFullscreenIcon();

          if (this.container) {
            this.container.classList.toggle(
              "storyline-fullscreen",
              this.isFullscreen
            );
          }
        }

        shouldShowLogoutButton() {
          const user = AuthSystem.getCurrentUser();
          const hash = window.location.hash;
          const isIntroSlide =
            hash.includes("63itxUiYU5C") || hash.includes("5rgG71N9RMX");
          const isAuthPage = window.location.pathname.includes("auth.html");

          return user && !isIntroSlide && !isAuthPage;
        }

        initButtons() {
          this.container =
            document.querySelector("#preso") || document.documentElement;
          const target = this.device.mobile ? document.body : this.container;

          // Ensure container positioning
          if (!this.device.mobile && target.style.position === "static") {
            target.style.position = "relative";
          }

          // Create fullscreen button
          if (!this.fullscreenBtn) {
            this.fullscreenBtn = this.createFullscreenButton();
            target.appendChild(this.fullscreenBtn);
            this.updateFullscreenIcon();
          }

          // Create logout button
          if (this.shouldShowLogoutButton() && !this.logoutBtn) {
            this.logoutBtn = this.createLogoutButton();
            target.appendChild(this.logoutBtn);
          } else if (!this.shouldShowLogoutButton() && this.logoutBtn) {
            this.logoutBtn.remove();
            this.logoutBtn = null;
          }
        }

        init() {
          // Setup fullscreen event listeners
          [
            "fullscreenchange",
            "webkitfullscreenchange",
            "mozfullscreenchange",
            "msfullscreenchange",
          ].forEach((event) => {
            document.addEventListener(event, () =>
              this.handleFullscreenChange()
            );
          });

          // Handle F11 key for desktop
          if (!this.device.mobile) {
            document.addEventListener("keydown", (e) => {
              if (e.key === "F11") {
                e.preventDefault();
                this.toggleFullscreen();
              }
            });
          }

          // Initialize buttons
          this.initButtons();

          // Monitor for changes
          window.addEventListener("hashchange", () => {
            setTimeout(() => this.initButtons(), 100);
          });

          // Periodic check
          setInterval(() => this.initButtons(), 3000);
        }
      }

      // ===========================================
      // LOADING SYSTEM
      // ===========================================
      class LoadingSystem {
        static setupMobileLoader() {
          const device = DeviceDetector.detect();
          if (!device.mobile) return;

          const loader = document.querySelector(".slide-loader");
          if (!loader) return;

          for (let i = 1; i <= 3; i++) {
            const dot = document.createElement("div");
            dot.style.backgroundColor = window.globals.preloaderColor;
            dot.classList.add("mobile-loader-dot", `dot${i}`);
            loader.appendChild(dot);
          }
        }

        static hideTitleOverlay() {
          const overlay = document.querySelector(".mobile-load-title-overlay");
          if (overlay && (window.autoSpider || window.vInterfaceObject)) {
            overlay.classList.add("hidden");
          }
        }
      }

      // ===========================================
      // APPLICATION INITIALIZATION
      // ===========================================
      class App {
        static init() {
          // Setup device detection
          const device = DeviceDetector.detect();
          window.globals.deviceView = device;

          // Add device classes to body
          Object.keys(device).forEach((key) => {
            if (device[key]) {
              document.body.classList.add(`view-${key}`);
            }
          });

          // Initialize systems
          AuthSystem.init();
          LoadingSystem.setupMobileLoader();
          LoadingSystem.hideTitleOverlay();

          // Initialize UI controls after a short delay
          setTimeout(() => {
            const uiControls = new UIControls();
            uiControls.init();
          }, 300);
        }
      }

      // ===========================================
      // GLOBAL FUNCTIONS
      // ===========================================
      window.logoutUser = () => AuthSystem.logout();
      window.getUserDisplayName = () => {
        const user = AuthSystem.getCurrentUser();
        return user ? user.nama_lengkap || "User" : "Guest";
      };

      // ===========================================
      // START APPLICATION
      // ===========================================
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", App.init);
      } else {
        App.init();
      }
    </script>

    <!-- External Scripts -->
    <script src="story_content/user.js"></script>
    <script src="html5/lib/scripts/bootstrapper.min.js"></script>
    <link rel="stylesheet" href="html5/data/css/output.min.css" data-noprefix />
  </body>
</html>
